{% extends 'base.html' %}

{% load static %}

{% block content %}

<!-- Main Image Section -->
<div class="w-full relative" style="height: 65vh;">

    <!-- Trip Name for Desktop View -->
    <div class="w-full relative gradient-container" style="height: 65vh;">
        {% if trip.main_image %}
            <img class="absolute w-full h-full object-cover"
                src="{{ trip.main_image.url }}"
                alt="{{ trip.name }}">
        {% else %}
            <img class="absolute w-full h-full object-cover"
                src="{{ trip.default_image_url }}"
                alt="{{ trip.name }}">
        {% endif %}
        
        <div class=" md:w-[70%] absolute bottom-0 left-0 right-0 hidden sm:block text-container">
            
            <!-- Breadcrumbs WIP -->
            <div class=" text-white breadcrumbs pb-0 pl-5">
                <ul>
                    <li><a>Home</a></li> 
                    <li><a>Explore</a></li>
                    <li>France</li>
                </ul>
            </div>
            <h1 class="text-white uppercase text-6xl font-bold pb-4 pl-4 max-w-11/12">
                {{ trip.name }}
            </h1>
        </div>
        <div class="absolute bottom-0 left-0 right-0 hidden sm:block gradient-bg"></div>
    </div>
</div>

<!-- Main Content Container -->
<div  class="bg-gray-900">

    <!-- Grid Layout for Trip Details and Price -->
    <div class="mb-5 md:mb-0 md:grid md:grid-cols-[2fr,1fr]">

        <!-- Horizontal Line -->
        <hr class="h-px mb-0 bg-gray-200 border-0 dark:bg-gray-700 col-span-3">

        <!-- Trip Details Section -->
        <div class="px-4 flex-col sm:flex-row pt-4 md:col-span-1">

            <!-- Breadcrumbs WIP -->
            <div class="text-sm text-white breadcrumbs sm:hidden">
                <ul>
                    <li><a>Home</a></li> 
                    <li><a>Explore</a></li>
                    <li>France</li>
                </ul>
            </div>

            <!-- Trip Name -->
            <h1 class="text-white uppercase text-4xl font-bold mb-5 sm:hidden"
                aria-label="Trip name">
                {{ trip.name }}
            </h1>
            <hr class="h-px mb-0 bg-gray-200 border-0 dark:bg-gray-700 col-span-3 sm:hidden">

            <!-- Trip Details Grid -->
            <div class="grid grid-cols-2 sm:flex justify-center sm:gap-6 md:gap-0 mt-2">
                {% for item in trip_details %}
                    {% if item.label == 'Rating' %}
                        <div class="flex flex-row py-4 items-center sm:max-w-[15%] md:min-w-[20%]  sm:flex-col sm:items-center md:hidden">
                    {% else %}
                        <div class="flex flex-row py-4 items-center sm:max-w-[15%] md:min-w-[20%]  sm:flex-col sm:items-center">
                    {% endif %}
                    <img src="{% static item.icon %}" alt="{{ item.alt }}"
                        class=" bg-gray-800 btn-circle shadow-lg p-2 w-10 h-10 sm:w-14 sm:h-14 md:w-14 md:h-14 lg:w-16 lg:h-16">
                        <div class="pl-2 sm:text-center sm:pl-0 sm:mt-2">
                            <p class="text-secondary font-bold uppercase sm:text-xs">
                                {{ item.label }}
                            </p>
                            {% if item.label == 'Rating' %}
                                {% if item.value == "0.0" %}
                                    <span class="badge badge-sm font-medium -ml-1 sm:ml-0">
                                        New Trip
                                    </span>
                                {% else %}
                                    <p class="text-white text-sm inline-flex items-center">
                                        <span class="font-thin">
                                            {{ item.value }}
                                        </span>
                                        /5.0 
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="orange" viewBox="0 0 24 24" stroke-width="1.5" stroke="none" class="w-4 h-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
                                        </svg>
                                    </p>
                                {% endif %}
                            {% else %}
                                <p class="text-white">
                                    {{ item.value }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

        </div>

        <!-- Trip Price Section -->
        <div class="hidden md:grid lg:block bg-white p-4 md:pb-0 md:col-span-1">
            <p class="text-xl text-center text-primary">
                Book this trip today
            </p>
            <p class="flex justify-center items-center text-4xl font-bold text-primary my-2">
                €{{ trip.price }}
                <span class="text-lg font-normal">
                    /pp
                </span>
            </p>
            <div class="rating flex justify-center w-full">
                
                <!-- Reviews WIP -->

                    {% include 'includes/reviews/review-stars.html'%}

                    {% if trip.overall_rating %}
                        <a href="{% url 'trip_details' trip.id %}?tab=reviews"
                            hx-get="{% url 'trip_reviews' trip.id %}"
                            hx-trigger="click"
                            hx-target="#trip-sub-section"
                            class="ml-1 mt-1 text-sm text-blue-500">
                            ({{ review_count }} review{{ review_count|pluralize }})
                        </a>
                    {% else %}
                        <span class="badge badge-sm badge-accent badge-outline ml-1">
                            New
                        </span>
                    {% endif %}
                </div>
                <label for="my-drawer-4"
                        class="btn btn-secondary w-full mt-2"
                        hx-get="{% url 'booking_drawer' trip.id %}"
                        hx-trigger="click"
                        hx-target="#booking-drawer-content">
                        Available Dates
                </label>
        </div>

        <!-- Sticky Bottom Button -->
        <div class="md:hidden shadow-inner fixed inset-x-0 bottom-0 z-50 bg-white p-2 flex items-center justify-between">
            <label for="my-drawer-4"
                    class="btn btn-secondary "
                    hx-get="{% url 'booking_drawer' trip.id %}"
                    hx-trigger="click"
                    hx-target="#booking-drawer-content">
                    Available Dates
            </label>
            <p class="inline-flex items-center text-2xl text-center shad font-bold text-black ml-auto">
                €{{ trip.price }}
                <span class="text-sm font-normal">
                    /pp
                </span>
            </p>
        </div>
    </div>

    <!-- Trip Sub Details WIP -->
    <div class="bg-white md:grid md:grid-cols-[2fr,1fr]">
        <div class="tabs pt-4 flex justify-center">
            <a class="tab tab-bordered tab-active"
                aria-label="Trip Details">
                Trip Details
            </a> 
            <a class="tab tab-bordered"
                aria-label="What's Included">
                What's Included
            </a>
            <a id="reviewsTab"
                class="tab tab-bordered"
                aria-label="Reviews"
                hx-get="{% url 'trip_reviews' trip.id %}"
                hx-trigger="click"
                hx-target="#trip-sub-section">
                Reviews
            </a> 
            <div id="trip-sub-section" class="p-6 w-full">

            </div>
        </div>    
    </div>
</div>

<!-- Booking Drawer Include -->
{% include 'includes/booking/booking-drawer.html' %}

<!-- JavaScript Section -->
<script>

    // Function to manage tab active state
    function manageActiveTab(tabElement) {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('tab-active'));
        tabElement.classList.add('tab-active');
    }

    // Initialize when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", function() {

        // Handling tab clicks to toggle active state
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach(tab => {
            tab.addEventListener("click", function() {
                manageActiveTab(this);
            });
        });

        // Check URL parameters for specific tab
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');

        if (tab === 'reviews') {
            const reviewsTab = document.querySelector('a[hx-get="{% url 'trip_reviews' trip.id %}"]');
            if (reviewsTab) {
                manageActiveTab(reviewsTab);
                reviewsTab.click();
                reviewsTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });

    // htmx specific event after DOM swap
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const reviewsTab = document.getElementById('reviewsTab');
        if (reviewsTab) {
            manageActiveTab(reviewsTab);
            reviewsTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });

</script>

{% endblock %}